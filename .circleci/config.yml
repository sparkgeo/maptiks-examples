version: 2

defaults: &defaults
  docker:
    - image: sparkgeo/base:circleci
  working_directory: ~/project

jobs:

  reset-master:
    <<: *defaults
    steps:
      - checkout
      - run:
          name: Resetting master to $CIRCLE_TAG
          command: |
            git config user.email "alain+sparkgeobot@sparkgeo.com"
            git config user.name "SparkgeoBot"
            git push origin ${CIRCLE_SHA1:0:7}:master
      - run:
          name: Merge $CIRCLE_TAG into develop
          command: |
            git checkout origin/develop
            git merge ${CIRCLE_SHA1:0:7} -m "Merge ${CIRCLE_TAG} into develop"
            git push origin HEAD:develop

  deploy-prod:
    <<: *defaults
    steps:
      - checkout
      - run:
          name: Envir Injection
          command: |
            find src -name 'index.html' -exec sed -i 's/cdn-dev.maptiks.com/cdn.maptiks.com/g' {} +
            find src -name 'index.html' -exec sed -i 's/6e668c95-0477-4208-b4ee-0fc1f41427de/ebd0926f-a4ab-4f66-b2e1-840828a4c3ed/g' {} +
      - run:
          name: deploy to aws
          command: aws s3 sync src/ s3://maptiks.com/ --delete
      - run:
          name: clear cloudflare cache
          command: |
            curl -X DELETE "https://api.cloudflare.com/client/v4/zones/34e8519f80106c3699e76002b4153ce5/purge_cache" -H "X-Auth-Email: will@sparkgeo.com" -H "X-Auth-Key: $CF_KEY" -H "Content-Type: application/json" --data '{"purge_everything": true}'


  deploy-staging:
    <<: *defaults
    steps:
      - checkout
      - run:
          name: Envir Injection
          command: |
            find src -name 'index.html' -exec sed -i 's/cdn-dev.maptiks.com/cdn-staging.maptiks.com/g' {} +
            find src -name 'index.html' -exec sed -i 's/6e668c95-0477-4208-b4ee-0fc1f41427de/69b19b9d-122b-48a9-a0cd-37b39e06e556/g' {} +
      - run:
          name: deploy to aws
          command: aws s3 sync src/ s3://landing-staging.maptiks.com/ --delete
      # - run:
      #     name: clear cloudflare cache
      #     command: |
      #       curl -X DELETE "https://api.cloudflare.com/client/v4/zones/34e8519f80106c3699e76002b4153ce5/purge_cache" -H "X-Auth-Email: will@sparkgeo.com" -H "X-Auth-Key: $CF_KEY" -H "Content-Type: application/json" --data '{"purge_everything": true}'


  deploy-dev:
    <<: *defaults
    steps:
      - checkout
      - run:
          name: Envir Injection
          command: |
            find src -name 'index.html' -exec sed -i 's/cdn-dev.maptiks.com/cdn-dev.maptiks.com/g' {} +
            find src -name 'index.html' -exec sed -i 's/6e668c95-0477-4208-b4ee-0fc1f41427de/529145ea-877b-4ebd-b8f9-62205d1bc01e/g' {} +
      - run:
          name: deploy to aws
          command: aws s3 sync src/ s3://landing-dev.maptiks.com/ --delete
      # - run:
      #     name: clear cloudflare cache
      #     command: |
      #       curl -X DELETE "https://api.cloudflare.com/client/v4/zones/34e8519f80106c3699e76002b4153ce5/purge_cache" -H "X-Auth-Email: will@sparkgeo.com" -H "X-Auth-Key: $CF_KEY" -H "Content-Type: application/json" --data '{"purge_everything": true}'


workflows:
  version: 2
  deploy:
    jobs:
      - deploy-prod:
          context: org-global
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /v[0-9]+(\.[0-9]+)+/
      - deploy-staging:
          context: org-global
          filters:
            branches:
              only: /rc[0-9]+(\.[0-9]+)+/
      - deploy-dev:
          context: org-global
          filters:
            branches:
              only: develop
      - reset-master:
          context: org-global
          requires:
            - deploy-prod
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /v[0-9]+(\.[0-9]+)+/
